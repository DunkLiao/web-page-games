<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‰ä¼Šå¡å“‡ï¼šå°è—è»Šæ‹”è‰å¤§è¡åˆº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kosugi+Maru&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #fff9e6;
            font-family: 'Kosugi Maru', 'Microsoft JhengHei', sans-serif;
            touch-action: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        canvas {
            border: 6px solid #ffcfd2;
            border-radius: 30px;
            background-color: #e2f0d9;
            box-shadow: 0 8px 0px #f8bbd0;
            z-index: 1;
        }

        .chiikawa-ui {
            z-index: 20;
            color: #7a5c5c;
            font-weight: bold;
        }

        .bubbly-btn {
            background: #ffcfd2;
            border: none;
            color: #7a5c5c;
            box-shadow: 0 6px 0px #f8bbd0;
            border-radius: 50px;
            transition: all 0.1s;
            cursor: pointer;
            user-select: none;
            text-align: center;
        }

        .bubbly-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0px #f8bbd0;
        }

        .secondary-btn {
            background: #fff;
            box-shadow: 0 6px 0px #e2f0d9;
        }

        .settings-panel {
            background: white;
            border: 4px solid #ffcfd2;
            border-radius: 30px;
            padding: 20px;
            width: 300px;
            margin-top: 15px;
        }

        @keyframes floatingPop {
            0% { transform: scale(0) translateY(0); opacity: 0; }
            30% { transform: scale(1.2) translateY(-20px); opacity: 1; }
            100% { transform: scale(1) translateY(-40px); opacity: 0; }
        }

        .bubble-text {
            position: absolute;
            pointer-events: none;
            background: white;
            border: 3px solid #7a5c5c;
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 1.5rem;
            color: #7a5c5c;
            animation: floatingPop 1.2s ease-out forwards;
            z-index: 50;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            z-index: 20;
        }
        .control-btn {
            width: 70px;
            height: 70px;
            background: #fff;
            border: 4px solid #ffcfd2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 5px 0px #ffcfd2;
            user-select: none;
        }
        
        input[type=range] {
            accent-color: #ff8fa3;
            width: 100%;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="game-container">
    <!-- UI é ‚éƒ¨ç‹€æ…‹ -->
    <div class="absolute top-4 flex w-full justify-between px-8 chiikawa-ui text-lg">
        <div>æ‹”è‰æˆç¸¾: <span id="score" class="text-pink-500">0</span></div>
        <div class="opacity-60 text-xs">æœ€é«˜ç´€éŒ„: <span id="high-score">0</span></div>
    </div>

    <!-- éŠæˆ²ç•«å¸ƒ -->
    <canvas id="gameCanvas"></canvas>

    <!-- éŠæˆ²é¸å–®èˆ‡è¨­å®šé¢æ¿ -->
    <div id="start-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-white/90 z-30">
        <div class="mb-2 text-6xl">ğŸ±ğŸš™</div>
        <h1 class="text-2xl font-bold text-[#7a5c5c] mb-1">å‰ä¼Šå¡å“‡ï¼šå°è—è»Šæ‹”è‰å¤§è¡åˆº</h1>
        
        <div class="settings-panel shadow-sm mb-6">
            <h3 class="text-center font-bold text-[#7a5c5c] mb-3">âš™ï¸ å†’éšªè¨­å®š</h3>
            <div class="mb-4">
                <div class="flex justify-between text-sm mb-1 text-[#7a5c5c]">
                    <span>è¡åˆºé€Ÿåº¦</span>
                    <span id="speed-val" class="font-bold">4</span>
                </div>
                <input type="range" id="speed-slider" min="2" max="15" value="4" step="1">
            </div>
            <div>
                <div class="flex justify-between text-sm mb-1 text-[#7a5c5c]">
                    <span>è¨ä¼å°è±¡é »ç‡</span>
                    <span id="freq-val" class="font-bold">ä½</span>
                </div>
                <input type="range" id="freq-slider" min="1" max="10" value="2" step="1">
            </div>
        </div>

        <button id="start-button" class="bubbly-btn text-xl px-12 py-3 font-bold">
            å‡ºç™¼æ‹”è‰å›‰ï¼
        </button>
    </div>

    <!-- éŠæˆ²çµæŸç•«é¢ -->
    <div id="game-over-screen" class="absolute inset-0 flex flex-col items-center justify-center bg-[#fff0f0]/95 z-30 hidden">
        <div class="mb-2 text-7xl">ğŸ˜­</div>
        <h2 class="text-3xl font-bold text-red-400 mb-2">å—šã€å—šå“‡...ï¼</h2>
        <p class="text-[#7a5c5c] text-xl mb-6">æœ€çµ‚æ‹”è‰æˆç¸¾: <span id="final-score">0</span></p>
        
        <div class="flex flex-col gap-4 w-64">
            <button id="quick-restart-btn" class="bubbly-btn text-lg py-3 font-bold">
                å†æ¬¡æŒ‘æˆ° (ç¶­æŒè¨­å®š)
            </button>
            <button id="back-to-settings-btn" class="bubbly-btn secondary-btn text-lg py-3 font-bold">
                è¿”å›èª¿æ•´é›£åº¦
            </button>
        </div>
    </div>

    <!-- è¡Œå‹•è£ç½®è™›æ“¬æŒ‰éˆ• -->
    <div class="controls lg:hidden">
        <div id="left-btn" class="control-btn">ğŸ‘ˆ</div>
        <div id="right-btn" class="control-btn">ğŸ‘‰</div>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreElement = document.getElementById('score');
    const highScoreElement = document.getElementById('high-score');
    const finalScoreElement = document.getElementById('final-score');
    const startScreen = document.getElementById('start-screen');
    const gameOverScreen = document.getElementById('game-over-screen');
    
    const speedSlider = document.getElementById('speed-slider');
    const freqSlider = document.getElementById('freq-slider');
    const speedValText = document.getElementById('speed-val');
    const freqValText = document.getElementById('freq-val');

    let canvasWidth, canvasHeight;
    let score = 0;
    let highScore = localStorage.getItem('chiikawaDashHighScore') || 0;
    let isGameRunning = false;
    let gameSpeed = 4;
    let spawnProb = 0.02;
    let obstacles = [];
    let decorations = [];
    let animationId;
    
    // 5 è»Œé“æ¨¡å¼
    const LANE_COUNT = 5;

    const player = {
        width: 45,
        height: 45,
        x: 0,
        y: 0,
        lane: 2, // åˆå§‹ä½ç½®åœ¨ç¬¬ 3 è»Œ (ç´¢å¼• 2)
        targetX: 0
    };

    function initCanvas() {
        canvasWidth = Math.min(window.innerWidth - 30, 380);
        canvasHeight = window.innerHeight * 0.55;
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        
        updatePlayerX();
        player.y = canvasHeight - player.height - 30;
        
        highScoreElement.innerText = highScore;
    }

    function updatePlayerX() {
        const laneWidth = canvasWidth / LANE_COUNT;
        player.targetX = laneWidth * player.lane + (laneWidth - player.width) / 2;
        if (!isGameRunning && obstacles.length === 0) player.x = player.targetX;
    }

    class Decoration {
        constructor() {
            this.x = Math.random() * canvasWidth;
            this.y = Math.random() * canvasHeight;
            this.size = 15 + Math.random() * 15;
            this.speed = 1.0;
            this.emoji = Math.random() > 0.5 ? 'ğŸŒ¸' : 'ğŸŒ¿';
        }
        update() {
            this.y += this.speed;
            if (this.y > canvasHeight + 20) {
                this.y = -20;
                this.x = Math.random() * canvasWidth;
            }
        }
        draw() {
            ctx.font = `${this.size}px Arial`;
            ctx.fillText(this.emoji, this.x, this.y);
        }
    }

    class Obstacle {
        constructor() {
            this.width = 40;
            this.height = 40;
            this.lane = Math.floor(Math.random() * LANE_COUNT);
            const laneWidth = canvasWidth / LANE_COUNT;
            this.x = laneWidth * this.lane + (laneWidth - this.width) / 2;
            this.y = -60;
            this.speed = gameSpeed * (0.85 + Math.random() * 0.3);
            const items = ['ğŸ¥¦', 'ğŸ‘¹', 'ğŸ¿ï¸', 'ğŸ„', 'ğŸ', 'ğŸª¨', 'â­', 'ğŸ'];
            this.emoji = items[Math.floor(Math.random() * items.length)];
        }
        update() { this.y += this.speed; }
        draw() {
            ctx.font = '40px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(this.emoji, this.x + this.width/2, this.y + this.height/2);
        }
    }

    function showBubble(text) {
        const bubble = document.createElement('div');
        bubble.className = 'bubble-text';
        bubble.innerText = text;
        bubble.style.left = Math.random() * 40 + 30 + '%';
        bubble.style.top = '40%';
        document.getElementById('game-container').appendChild(bubble);
        setTimeout(() => bubble.remove(), 1200);
    }

    function drawScene() {
        ctx.fillStyle = '#e2f0d9';
        ctx.fillRect(0, 0, canvasWidth, canvasHeight);
        
        decorations.forEach(d => {
            d.update();
            d.draw();
        });

        // è»Œé“åˆ†å‰²ç·š
        ctx.strokeStyle = '#c5e0b4';
        ctx.setLineDash([10, 15]);
        ctx.lineWidth = 2;
        for (let i = 1; i < LANE_COUNT; i++) {
            ctx.beginPath();
            ctx.moveTo(i * (canvasWidth / LANE_COUNT), 0);
            ctx.lineTo(i * (canvasWidth / LANE_COUNT), canvasHeight);
            ctx.stroke();
        }
        ctx.setLineDash([]);
    }

    function drawPlayer() {
        player.x += (player.targetX - player.x) * 0.22;
        ctx.save();
        ctx.translate(player.x + player.width/2, player.y + player.height/2);
        const tilt = (player.targetX - player.x) * 0.05;
        ctx.rotate(tilt);
        ctx.font = '50px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('ğŸš™', 0, 0); 
        ctx.font = '24px Arial';
        ctx.fillText('ğŸ±', 0, -8); 
        ctx.restore();
    }

    function gameLoop() {
        if (!isGameRunning) return;

        drawScene();
        drawPlayer();

        for (let i = obstacles.length - 1; i >= 0; i--) {
            obstacles[i].update();
            obstacles[i].draw();

            if (
                player.x + 8 < obstacles[i].x + obstacles[i].width - 8 &&
                player.x + player.width - 8 > obstacles[i].x + 8 &&
                player.y + 8 < obstacles[i].y + obstacles[i].height - 8 &&
                player.y + player.height - 8 > obstacles[i].y + 8
            ) {
                endGame();
                return;
            }

            if (obstacles[i].y > canvasHeight) {
                obstacles.splice(i, 1);
                score += 10;
                scoreElement.innerText = score;
                
                if (score % 200 === 0) {
                    gameSpeed += 0.25;
                    showBubble('å‘€å“ˆï¼');
                }
            }
        }

        if (Math.random() < spawnProb) {
            obstacles.push(new Obstacle());
        }

        animationId = requestAnimationFrame(gameLoop);
    }

    function startGame() {
        gameSpeed = parseInt(speedSlider.value);
        spawnProb = parseInt(freqSlider.value) * 0.015;

        score = 0;
        obstacles = [];
        player.lane = 2;
        updatePlayerX();
        player.x = player.targetX;
        
        decorations = Array.from({length: 15}, () => new Decoration());
        isGameRunning = true;
        scoreElement.innerText = score;
        startScreen.classList.add('hidden');
        gameOverScreen.classList.add('hidden');
        showBubble('GOï¼');
        gameLoop();
    }

    function endGame() {
        isGameRunning = false;
        cancelAnimationFrame(animationId);
        if (score > highScore) {
            highScore = score;
            localStorage.setItem('chiikawaDashHighScore', highScore);
            highScoreElement.innerText = highScore;
        }
        finalScoreElement.innerText = score;
        gameOverScreen.classList.remove('hidden');
        showBubble('å—šå“‡...ï¼');
    }

    function moveLeft() {
        if (player.lane > 0) {
            player.lane--;
            updatePlayerX();
        }
    }
    function moveRight() {
        if (player.lane < LANE_COUNT - 1) {
            player.lane++;
            updatePlayerX();
        }
    }

    speedSlider.oninput = function() {
        speedValText.innerText = this.value;
    };
    freqSlider.oninput = function() {
        const labels = ["æ¥µä½", "ä½", "æ™®é€š", "ç¨å¤š", "å¾ˆå¤š", "æŒ‘æˆ°", "ç˜‹ç‹‚", "å™©å¤¢", "åœ°ç„", "è¨ä¼ç´š"];
        freqValText.innerText = labels[this.value - 1];
    };

    window.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowLeft') moveLeft();
        if (e.key === 'ArrowRight') moveRight();
    });
    
    document.getElementById('start-button').addEventListener('click', startGame);
    document.getElementById('quick-restart-btn').addEventListener('click', startGame);
    document.getElementById('back-to-settings-btn').addEventListener('click', () => {
        gameOverScreen.classList.add('hidden');
        startScreen.classList.remove('hidden');
    });
    
    document.getElementById('left-btn').addEventListener('touchstart', (e) => { e.preventDefault(); moveLeft(); });
    document.getElementById('right-btn').addEventListener('touchstart', (e) => { e.preventDefault(); moveRight(); });

    window.addEventListener('resize', initCanvas);
    window.onload = initCanvas;

</script>
</body>
</html>